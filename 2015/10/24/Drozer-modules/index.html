<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>实战Drozer模块编写 | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">实战Drozer模块编写</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">实战Drozer模块编写</h1><div class="post-meta">Oct 24, 2015<span> | </span><span class="category"><a href="/categories/移动安全/">移动安全</a></span></div><div class="post-content"><p>作者: thor</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>drozer是MWR Labs开发的一款Android安全测试框架。是目前最好的Android安全测试工具之一。drozer提供了命令行交互式界面，使用drozer进行安全测试，用户在自己的console端输入命令，drozer会将命令发送到Android设备上的drozer agent代理程序执行。drozer采用了模块化的设计，用户可以定制开发需要的测试模块。编写drozer模块主要涉及python模块及dex模块。python模块在drozer console端运行，类似于metasploit中的插件，可以扩展drozer console的测试功能。dex模块是java编写的android代码，类似于android的dex插件，在android手机上运行，用于扩展drozer agent的功能。</p>
<h2 id="0x00-简单的drozer模块demo代码"><a href="#0x00-简单的drozer模块demo代码" class="headerlink" title="0x00 简单的drozer模块demo代码"></a>0x00 简单的drozer模块demo代码</h2><p>首先看看drozer wiki给出的demo，该模块的功能就是在android设备上反射调用java.util.Random类生成一个随机数并返回：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">from drozer.modules import Module</div><div class="line"></div><div class="line">	class GetInteger(Module):</div><div class="line">	</div><div class="line">	    name = &quot;&quot;</div><div class="line">	    description = &quot;&quot;</div><div class="line">	    examples = &quot;&quot;</div><div class="line">	    author = &quot;Joe Bloggs (@jbloggs)&quot;</div><div class="line">	    date = &quot;2012-12-21&quot;</div><div class="line">	    license = &quot;BSD (3-clause)&quot;</div><div class="line">	    path = [&quot;exp&quot;, &quot;test&quot;]</div><div class="line">	</div><div class="line">	    def execute(self, arguments):</div><div class="line">	        random = self.new(&quot;java.util.Random&quot;)</div><div class="line">	        integer = random.nextInt()</div><div class="line">	</div><div class="line">	        self.stdout.write(&quot;int: %d\n&quot; % integer)</div></pre></td></tr></table></figure>
<p>GetInteger类就是一个简单的drozer模块，它继承自drozer提供的模块基类Module。每个继承了Module的类都对应着一个drozer模块，模块具体实现的功能则是在类中重写excute函数，实现新的功能。在drozer console中执行以下命令就可以运行该模块了：  </p>
<p><code>dz&gt; run exp.test.getinteger</code></p>
<p>运行效果如下：   </p>
<p><img src="/2015/10/24/Drozer-modules/1.png" alt="1"></p>
<p>drozer 通过Module类的metadata来配置和管理每个模块,因此模块编写时需要包含以下 metadata信息:        </p>
<pre><code>name          模块的名称
description   模块的功能描述 
examples      模块的使用示例
author        作者
date          日期
license       许可
path          描述模块命令空间
</code></pre><p>这些信息中比较重要的就是path变量，它描述了模块在drozer namespace中的路径，结合对应的classname可以唯一确定drozer中的模块。例如demo中的path = [“exp”, “test”],类名为GetInteger，那么在drozer console中该模块就以exp.test.getinteger唯一确定。需要注意的是，尽管类的名字有大小写之分，但运行该模块的时候，drozer console中的名字都为小写。</p>
<h2 id="0x01-drozer模块仓库的创建及模块安装"><a href="#0x01-drozer模块仓库的创建及模块安装" class="headerlink" title="0x01 drozer模块仓库的创建及模块安装"></a>0x01 drozer模块仓库的创建及模块安装</h2><p>drozer模块安装有两种方法，一种是直接在repository中按照python包管理的方法新建目录结构，将python文件放入相应目录中，另一种是在drozer console中通过module install命令直接安装模块。</p>
<p>这两种方法都必须先在本地创建一个drozer 的repository目录，可以直接在drozer console中通过命令创建：</p>
<p> <code>dz&gt; module repository create [/path/to/repository]</code></p>
<p>也可以在~/.drozer_config文件中指定本地repository目录</p>
<pre><code>[repositories]    
/path/to/repository  =  /path/to/repository
</code></pre><p>创建好本地repository后就可以安装自己的模块了。两种安装方法：</p>
<p>1) 按照python包管理的方式，在本地repository目录下创建目录exp,新建__int__.py空白文件，然后将Python模块源码放入exp目录即可。例如将test.py放入exp目录下，test.py的内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">	from drozer.modules import Module</div><div class="line"></div><div class="line">class GetInteger(Module):</div><div class="line"></div><div class="line">    name = &quot;&quot;</div><div class="line">    description = &quot;&quot;</div><div class="line">    examples = &quot;&quot;</div><div class="line">    author = &quot;Joe Bloggs (@jbloggs)&quot;</div><div class="line">    date = &quot;2012-12-21&quot;</div><div class="line">    license = &quot;BSD (3-clause)&quot;</div><div class="line">    path = [&quot;exp&quot;, &quot;test&quot;]</div><div class="line"></div><div class="line">    def execute(self, arguments):</div><div class="line">        random = self.new(&quot;java.util.Random&quot;)</div><div class="line">        integer = random.nextInt()</div><div class="line"></div><div class="line">        self.stdout.write(&quot;int: %d\n&quot; % integer)</div></pre></td></tr></table></figure>
<p>安装好模块之后即可在drozer console端通过命令run exp.test.getinteger运行该模块了。</p>
<p>2) 通过drozer console中的命令module install 安装。首先将编辑好的python模块源文件命名为 exp.test2,文件的内容同上。在drozer console中执行   </p>
<p><code>dz&gt; module install  [/path/to/exp.test2]</code>      </p>
<p>执行成功后则可以在本地repository目录下exp目录中看到生成了test2.py文件，内容和原来的exp.test2文件一致。安装成功后及可执行该模块了。module install除了可以安装本地仓库的模块外，还可以远程安装gitbub上的模块，地址为    </p>
<pre><code>https://raw.github.com/mwrlabs/drozer-modules/repository/
</code></pre><p>例如运行</p>
<p><code>dz&gt;module install jubax.javascript</code></p>
<p>将远程下载并安装scanner.misc.checkjavascriptbridge模块，安装完成后执行</p>
<p><code>dz&gt; run scanner.misc.checkjavascriptbridge</code></p>
<p>就可以运行该模块，该模块的功能是检查webview中addJavascriptInterface的使用是否存在安全隐患。</p>
<h2 id="0x02-利用drozer提供的API扩展功能"><a href="#0x02-利用drozer提供的API扩展功能" class="headerlink" title="0x02 利用drozer提供的API扩展功能"></a>0x02 利用drozer提供的API扩展功能</h2><p>drozer封装了android中大部分API功能，使得能够在python中方便的使用这些API扩展功能，发挥drozer及python的强大威力。</p>
<p>1）利用反射直接与Dalvik虚拟机交互，其实就是Python直接在写android代码，非常简单方便。drozer主要是利用了drozer agent代理实现相关功能，实例化某个类的代码如下：   </p>
<p><code>my_object = self.new(&quot;some.package.MyClass&quot;)</code></p>
<p>例如drozer.android模块中封装了Intent类，用户可以通过如下方式构造需要的Intent：</p>
<p><code>someintent = android.Intent(action=act, category=cat, data_uri=data, component=comp, extras=extr, flags=flgs)</code></p>
<p>然后通过intent打开某个activity: </p>
<p> <code>self.getContext().startActivity(someintent)</code></p>
<p>2) drozer针对比较常用的功能还二次封装了很多python的mixins工具类，提供了更简单易用的API，这些mixins都在drozer.modules.common包中：</p>
<pre><code>Assets
BusyBox
ClassLoader
FileSystem
Filters
PackageManager
Provider
ServiceBinding
Shell
Strings
SuperUser
TableFormatter
ZipFile
</code></pre><p>例如FileSystem类提供了访问android手机文件系统的接口，可以方便地读写、创建及删除andoid手机上的目录和文件。ZipFile类提供了解压zip文件的功能。<br>为了使用这些mixin类提供的功能，在模块中可以直接继承这些类就可以了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">from drozer.modules import common, Module</div><div class="line">	</div><div class="line">   class MyModule(Module, common.FileSystem, common.ZipFile):</div><div class="line">	       ……</div><div class="line">	       ……</div><div class="line">	   self.deleteFile(“somepath”)</div><div class="line">              ……</div><div class="line">              ……</div><div class="line">	   dex_file = self.extractFromZip(&quot;classes.dex&quot;, path, self.cacheDir())</div></pre></td></tr></table></figure>
<p>其中，self.deleteFile来自FileSystem类，self.extractFromZip来自ZipFile类。</p>
<p>##0x03 实现find port及find IP模块</p>
<p>1) app开放端口查找模块</p>
<p>Android app通常会监听某些端口进行本地IPC或者远程网络通信，但是这些暴露的端口却代表了潜在的本地或远程攻击面，具体可以参考大牛的文章：</p>
<p><a href="http://www.ms509.com/2015/07/12/android-open-port/" target="_blank" rel="external">浅谈Android开放网络端口的安全风险</a></p>
<p>文章中提供了查找开放端口及对应app的python脚本，我们将其重写为drozer模块，方便测试时使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">from drozer.modules import Module,common</div><div class="line">import re</div><div class="line"></div><div class="line">class findport(Module,common.Shell):</div><div class="line"></div><div class="line">    name = &quot;&quot;</div><div class="line">    description = &quot;find open port in android&quot;</div><div class="line">    examples = &quot;run exp.work.findport&quot;</div><div class="line">    author = &quot;thor@ms509&quot;</div><div class="line">    date = &quot;2015-12-02&quot;</div><div class="line">    license = &quot;BSD (3-clause)&quot;</div><div class="line">    path = [&quot;exp&quot;,&quot;work&quot;]</div><div class="line">    </div><div class="line">    def toHexPort(self,port):</div><div class="line">        hexport = str(hex(int(port)))</div><div class="line">        return hexport.strip(&apos;0x&apos;).upper()     </div><div class="line">        </div><div class="line">    def finduid(self,protocol, entry):</div><div class="line">        if (protocol==&apos;tcp&apos; or protocol==&apos;tcp6&apos;):</div><div class="line">            uid = entry.split()[-10]</div><div class="line"></div><div class="line">        else: # udp or udp6</div><div class="line">            uid = entry.split()[-6]</div><div class="line">    </div><div class="line">        try: </div><div class="line">            uid = int(uid)</div><div class="line">        except:</div><div class="line">            return -1 	</div><div class="line">        if (uid &gt; 10000): # just for non-system app</div><div class="line">            return &apos;u0_a&apos;+str(uid-10000) </div><div class="line">        else:</div><div class="line">            return -1</div><div class="line"></div><div class="line">    def execute(self, arguments):        </div><div class="line">        </div><div class="line">        proc_net = &quot;/proc/net/&quot;      </div><div class="line">        ret = self.shellExec(&quot;netstat -anp | grep -Ei &apos;listen|udp*&apos;&quot;)</div><div class="line">        list_line = ret.split(&apos;\n&apos;)</div><div class="line">        apps = []</div><div class="line">        strip_listline = []</div><div class="line">        #pattern = re.compile(&quot;^Proto&quot;) # omit the first line</div><div class="line">        </div><div class="line">        for line in list_line:              </div><div class="line">                if (line != &apos;&apos;):               </div><div class="line">                   socket_entry = line.split()</div><div class="line">                   protocol = socket_entry[0]  </div><div class="line">                   port = socket_entry[3].split(&apos;:&apos;)[-1]</div><div class="line">                   grep_appid = &apos;grep  &apos;+ self.toHexPort(port) + &apos; &apos; + proc_net + protocol                    </div><div class="line">                   </div><div class="line">                   net_entry = self.shellExec(grep_appid)                         </div><div class="line">                   uid = self.finduid(protocol, net_entry)</div><div class="line">                              </div><div class="line">                   if (uid == -1): </div><div class="line">                       continue</div><div class="line">                                 </div><div class="line">                   applist = self.shellExec(&apos;ps | grep &apos; + uid).split()    </div><div class="line">                   app = applist[8]</div><div class="line">                   apps.append(app)</div><div class="line">                   strip_listline.append(line)</div><div class="line">                   </div><div class="line">        itapp= iter(apps)</div><div class="line">        itline=iter(strip_listline)</div><div class="line">              </div><div class="line">        self.stdout.write(&quot;Proto  Recv-Q Send-Q  Local Address        Foreign Address        State            APP\r\n&quot;)</div><div class="line">        try:</div><div class="line">            while True:</div><div class="line">                self.stdout.write( itline.next() + &apos; &apos;*10 + itapp.next() + &apos;\n&apos;)</div><div class="line">                </div><div class="line">        except StopIteration:</div><div class="line">            pass</div><div class="line"></div><div class="line">        self.stdout.write(&apos;\n&apos;)</div></pre></td></tr></table></figure>
<p> 该模块的主要功能都是在findport类中的execute函数中实现，查找开放端口及app的方法和原来文章中的一样，这里主要用到了drozer提供的common.Shell类，用于在android设备上执行shell命令：    </p>
<p><code>ret = self.shellExec(&quot;netstat -anp | grep -Ei &#39;listen|udp*&#39;&quot;)</code> </p>
<p> 在drozer console中直接运行如下命令即可：       </p>
<p>   <code>dz&gt; run exp.work.findport</code></p>
<p> 运行效果如下：<br> <img src="/2015/10/24/Drozer-modules/3.png" alt="image"></p>
<p>2）app中IP地址扫描模块</p>
<p>drozer的scanner.misc.weburls提供了扫描app中http及https URL地址的功能，仿照该模块的功能，我们实现了app中IP地址的扫描模块，这些收集到的IP地址可以在web渗透测试中使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">import re</div><div class="line">from pydiesel.reflection import ReflectionException</div><div class="line">from drozer.modules import common, Module </div><div class="line"></div><div class="line">class findips(Module, common.FileSystem, common.PackageManager, common.Provider, common.Strings, common.ZipFile):</div><div class="line"></div><div class="line">    name = &quot;Find IPs specified in packages.&quot;</div><div class="line">    description = &quot;&quot;&quot;</div><div class="line">    Find IPs in apk files</div><div class="line">    &quot;&quot;&quot;</div><div class="line">    examples = &quot;&quot;</div><div class="line">    author = &quot;7h0r@ms509&quot;</div><div class="line">    date = &quot;2015-12-9&quot;</div><div class="line">    license = &quot;&quot;</div><div class="line">    path = [&quot;exp&quot;, &quot;server&quot;]</div><div class="line">    permissions = [&quot;com.mwr.dz.permissions.GET_CONTEXT&quot;]</div><div class="line"></div><div class="line">    def add_arguments(self, parser):</div><div class="line">        parser.add_argument(&quot;-a&quot;, &quot;--package&quot;, help=&quot;specify a package to search&quot;)</div><div class="line"></div><div class="line">    def execute(self, arguments):</div><div class="line">        self.ip_matcher = re.compile(r&quot;((?:(?:25[0-5]|2[0-4]\d|((1\d&#123;2&#125;)|([1-9]?\d)))\.)&#123;3&#125;(?:25[0-5]|2[0-4]\d|((1\d&#123;2&#125;)|([1-9]?\d))))&quot;)</div><div class="line">        if arguments.package != None:</div><div class="line">            self.check_package(arguments.package, arguments)</div><div class="line">        else:</div><div class="line">            for package in self.packageManager().getPackages(common.PackageManager.GET_PERMISSIONS):</div><div class="line">                try:</div><div class="line">                    self.check_package(package.packageName, arguments)</div><div class="line">                except Exception, e:</div><div class="line">                    print str(e)</div><div class="line"></div><div class="line">    def check_package(self, package, arguments):</div><div class="line">        self.deleteFile(&quot;/&quot;.join([self.cacheDir(), &quot;classes.dex&quot;]))</div><div class="line">        ips = []</div><div class="line">     </div><div class="line">        for path in self.packageManager().getSourcePaths(package):</div><div class="line">            strings = []</div><div class="line">            if &quot;.apk&quot; in path:</div><div class="line">                dex_file = self.extractFromZip(&quot;classes.dex&quot;, path, self.cacheDir())</div><div class="line">                if dex_file != None:</div><div class="line">                    strings = self.getStrings(dex_file.getAbsolutePath())</div><div class="line"></div><div class="line">                    dex_file.delete()</div><div class="line">                    strings += self.getStrings(path.replace(&quot;.apk&quot;, &quot;.odex&quot;)) </div><div class="line">            elif (&quot;.odex&quot; in path):</div><div class="line">                strings = self.getStrings(path)</div><div class="line">            else:</div><div class="line">                continue</div><div class="line"></div><div class="line">            for s in strings:</div><div class="line">                m = self.ip_matcher.search(s)</div><div class="line">                if m is not None:</div><div class="line">                    ips.append(s)</div><div class="line">                   </div><div class="line">            if len(ips) &gt; 0:</div><div class="line">                self.stdout.write(&quot;%s\n&quot; % str(package))</div><div class="line"></div><div class="line">            for ip in ips:</div><div class="line">                    self.stdout.write(&quot;  %s\n&quot; % ip)</div><div class="line"></div><div class="line">            if len(ips) &gt; 0 :</div><div class="line">                self.stdout.write(&quot;\n&quot;)</div></pre></td></tr></table></figure>
<p><code>add_arguments</code>函数是drozer提供的接口，用于添加命令行参数，这里我们添加了–package参数，用于指定app名称，如果没有指定–package参数，那么默认会查找所有app中的IP地址，比较耗时。check_package函数主要实现指定app扫描IP地址的功能，该函数首先从app相关目录中查找apk文件、odex文件，如果是apk文件则从apk文件中解压出classes.dex文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">for path in self.packageManager().getSourcePaths(package):</div><div class="line">	strings = []</div><div class="line">	if &quot;.apk&quot; in path:</div><div class="line">	    dex_file = self.extractFromZip(&quot;classes.dex&quot;, path, self.cacheDir())</div></pre></td></tr></table></figure>
<p>然后从得到的dex、odex文件中获取到所有的strings:</p>
<p><code>strings = self.getStrings(path)</code></p>
<p>这里的getStrings是drozer提供的API，实现了类似linux下strings命令的功能。</p>
<p>找到app中的所有strings后再用re匹配得到相应的IP地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">for s in strings:</div><div class="line">       m = self.ip_matcher.search(s)</div><div class="line">       if m is not None:</div><div class="line">           ips.append(s)</div></pre></td></tr></table></figure>
<p>ip_matcher的正则表达式为：</p>
<p><code>self.ip_matcher = re.compile(r&quot;((?:(?:25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d)))\.){3}(?:25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d))))&quot;)</code></p>
<p>最后，在drozer console中通过如下命令运行该模块：</p>
<p><code>dz&gt; run exp.server.findips -a com.dianping.v1</code></p>
<p>运行效果如下所示：</p>
<p><img src="/2015/10/24/Drozer-modules/4.png" alt="image"></p>
<h2 id="0x04-编写dex插件"><a href="#0x04-编写dex插件" class="headerlink" title="0x04 编写dex插件"></a>0x04 编写dex插件</h2><p>除了利用drozer以python代码形式提供的API，用户还可以用java代码编写dex插件。<br>例如下面的java代码就可以编译为drozer的dex插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">import java.io.File;</div><div class="line">import java.io.FileInputStream;</div><div class="line">import java.io.FileOutputStream;</div><div class="line">import java.io.IOException;</div><div class="line"></div><div class="line">import android.util.Base64;</div><div class="line">import android.util.Log;</div><div class="line">import android.widget.Toast;</div><div class="line">import android.net.Uri;</div><div class="line">import android.content.ContentResolver;</div><div class="line">import android.database.Cursor;</div><div class="line">import android.provider.ContactsContract;</div><div class="line">import android.content.Context;</div><div class="line"></div><div class="line"></div><div class="line">public class dextest &#123;</div><div class="line"></div><div class="line">  private static final int BUFFER_SIZE = 4096;</div><div class="line"></div><div class="line"></div><div class="line">    public static String test(Context c, String number) &#123;</div><div class="line"></div><div class="line">    		String name = null;</div><div class="line">			Uri uri = Uri.parse(&quot;content://com.android.contacts/data/phones/filter/&quot; + number);</div><div class="line">			ContentResolver resolver = c.getContentResolver();</div><div class="line">			Cursor cursor = resolver.query(uri, new String[]&#123;android.provider.ContactsContract.Data.DISPLAY_NAME&#125;, null, null, null);</div><div class="line">			if (cursor.moveToFirst()) &#123;</div><div class="line">			    name = cursor.getString(0);</div><div class="line">			    Log.d(&quot;drozer&quot;, name);</div><div class="line">		    &#125;</div><div class="line">		    cursor.close();</div><div class="line"></div><div class="line"></div><div class="line">         Log.d(&quot;drozer&quot;,&quot;this is a drozer dex module!&quot;);</div><div class="line">         return &quot;hello world! this is a test! &quot; + number + &quot;: &quot; + name;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先我们将该java文件编译为class文件：</p>
<p> <code>javac -cp lib/android.jar dextest.java</code></p>
<p>然后用android sdk提供的dx工具将class文件转换为dex文件：</p>
<p> <code>dx  --dex --output=dextest.apk dextest*.class</code></p>
<p>最后将生成的dextest.apk文件放到drozer的modules/common目录下，在编写drozer模块时可以通过以下方式调用该dex插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">dextest = self.loadClass(&quot;common/dextest.apk&quot;, &quot;dextest&quot;)</div><div class="line">self.stdout.write(&quot;[color red]get string from dex plugin: %s  [/color]\n&quot; % dextest.test(self.getContext(),&quot;181&quot; ) )</div></pre></td></tr></table></figure>
<p>该测试插件根据提供的部分电话号码去匹配手机通讯录中的联系人，并返回匹配到的联系人姓名，执行效果如下:</p>
<p><img src="/2015/10/24/Drozer-modules/2.png" alt="2"></p>
<p>dex插件是由drozer上传到android手机上加载执行，它的作用还是为drozer模块提供更方便易用的接口，扩展更多的功能。由于dex插件是Java编写的原生android代码，在执行效率上比通过反射调用更高。drozer的modules/common目录下包含了多个dex插件的源码，有兴趣的同学可以自己查看。</p>
<h2 id="0x05-drozer模块的reload及动态加载问题"><a href="#0x05-drozer模块的reload及动态加载问题" class="headerlink" title="0x05 drozer模块的reload及动态加载问题"></a>0x05 drozer模块的reload及动态加载问题</h2><p>编写drozer module难免会涉及到调试的问题，drozer console提供了debug选项，会在console中打印异常信息，但是比较麻烦的是，修改module源码后必须要重启drozer console才能生效。<br>查看drozer源码，发现drozer在debug模式下提供了reload命令，但是测试了下，在mac下并没有用，还是要重启console才能生效。仔细研究drozer loader.py的相关源码：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">def all(self, base):</div><div class="line">	 &quot;&quot;&quot;</div><div class="line">	 Loads all modules from the specified module repositories, and returns a  collection of module identifiers.</div><div class="line">	 &quot;&quot;&quot;</div><div class="line"></div><div class="line">       if(len(self.__modules) == 0):</div><div class="line">           self.__load(base)</div><div class="line"></div><div class="line">       return sorted(self.__modules.keys())</div><div class="line"></div><div class="line">   def get(self, base, key):</div><div class="line">       &quot;&quot;&quot;</div><div class="line">       Gets a module implementation, given its identifier.</div><div class="line">       &quot;&quot;&quot;</div><div class="line"></div><div class="line">       if(len(self.__modules) == 0):</div><div class="line">           self.__load(base)</div><div class="line">       </div><div class="line">       return self.__modules[key]</div><div class="line"></div><div class="line">   def reload(self):</div><div class="line">       self.__modules = &#123;&#125;</div></pre></td></tr></table></figure>
<p>reload命令将self.__modules置为空，在get中按理说就会重新加载所有的drozer模块。但是在mac下始终无法实现该功能，其他平台未做测试。这里就涉及到python模块的import及reload机制问题，在网上查找到python的reload机制一些解释：</p>
<p>reload会重新加载已加载的模块，但原来已经使用的实例还是会使用旧的模块， 而新生产的实例会使用新的模块, reload后还是用原来的内存地址；不能支持from。。import。。格式的模块进行重新加载。</p>
<pre><code>http://blog.csdn.net/five3/article/details/7762870
</code></pre><p>猜测可能就是这个问题，虽然用python的reload机制可以重新加载模块，但是以前使用的模块可能还是在使用中，导致修改的源码没有生效。<br>为什么不在执行时动态加载模块呢？这样可以保证加载的模块源码是最新的。<br>分析了drozer相关的所有源码，终于在session.py中找到实例化模块类的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">def __module(self, key):</div><div class="line">   &quot;&quot;&quot;</div><div class="line">   Gets a module instance, by identifier, and initialises it with the</div><div class="line">   required session parameters.</div><div class="line">   &quot;&quot;&quot;</div><div class="line"></div><div class="line">   module = None</div><div class="line"></div><div class="line">   try:</div><div class="line">       module = self.modules.get(self.__module_name(key))</div><div class="line">   except KeyError:</div><div class="line">       pass</div><div class="line"></div><div class="line">   if module == None:</div><div class="line">       try:</div><div class="line">           module = self.modules.get(key)</div><div class="line">       except KeyError:</div><div class="line">           pass</div><div class="line"></div><div class="line">   if module == None:</div><div class="line">       raise KeyError(key)</div><div class="line">   else:</div><div class="line">       return module(self)</div></pre></td></tr></table></figure>
<p>该函数的功能就是根据模块类的key实例化该模块，从而运行该模块。因此，我们可以在这里实现动态加载要运行的模块类，放弃已经加载的模块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">def __module(self, key):</div><div class="line"></div><div class="line">   &quot;&quot;&quot;</div><div class="line">   Gets a module instance, by identifier, and initialises it with the</div><div class="line">   required session parameters.</div><div class="line">   &quot;&quot;&quot;</div><div class="line"></div><div class="line">   module = None</div><div class="line"></div><div class="line">   try:</div><div class="line">       module = self.modules.get(self.__module_name(key))</div><div class="line">   except KeyError:</div><div class="line">       pass</div><div class="line"></div><div class="line">   if module == None:</div><div class="line">       try:</div><div class="line">           module = self.modules.get(key)</div><div class="line">       except KeyError:</div><div class="line">           pass</div><div class="line"></div><div class="line">   if module == None:</div><div class="line">       raise KeyError(key)</div><div class="line">   else:</div><div class="line"></div><div class="line">       #reload module</div><div class="line">       mod = reload(sys.modules[module.__module__])</div><div class="line">       </div><div class="line">       module_class_name = module.__name__</div><div class="line">       module_class = getattr(mod,module_class_name)  #get module class object</div><div class="line">       return module_class(self)</div></pre></td></tr></table></figure>
<p>关键的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#reload module   </div><div class="line">mod = reload(sys.modules[module.__module__])</div><div class="line"></div><div class="line">module_class_name = module.__name__</div><div class="line">module_class = getattr(mod,module_class_name)  #get module class object</div><div class="line">return module_class(self)</div></pre></td></tr></table></figure>
<p>首先使用python的reload函数重新加载指定的模块，然后再在重新加载的模块中查找到drozer模块关联的类，最后实例化并返回。只需添加几行代码便可实现动态加载模块类，这样调试的时候就不用每次重启drozer console了。这里只是提供了一种简单的实现动态加载模块的方法，主要是方便模块的编写及测试。</p>
</div><div class="tags"><a href="/tags/android/">android</a></div><div class="post-nav"><a href="/2016/01/22/glibc-heap-ctf-writeup/" class="pre">glibc堆溢出学习笔记（兼2015强网杯shellman writeup)</a><a href="/2015/07/12/android-open-port/" class="next">浅谈Android开放网络端口的安全风险</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Malware分析/">Malware分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/渗透测试/">渗透测试</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web安全/">Web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/">二进制</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/原创漏洞/">原创漏洞</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制安全/">二进制安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/原创漏洞/">原创漏洞</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安卓/">安卓</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/移动安全/">移动安全</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/移动安全/二进制安全/">二进制安全</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/antiav/" style="font-size: 15px;">antiav</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/cknife/" style="font-size: 15px;">cknife</a> <a href="/tags/pwn/" style="font-size: 15px;">pwn</a> <a href="/tags/ios/" style="font-size: 15px;">ios</a> <a href="/tags/ms509/" style="font-size: 15px;">ms509</a> <a href="/tags/wannacry/" style="font-size: 15px;">wannacry</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/Rootme-uaf-writeup/">Rootme CTF UAF Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/22/android-blueborne2/">Android蓝牙远程命令执行漏洞利用实践 exploit优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/14/blueborne/">Android蓝牙远程命令执行漏洞利用实践:从PoC到exploit</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/04/github-infoleak/">Github信息泄露升级版案例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/14/Moto-bootloader-exploit/">CVE-2016-10277在MOTO X手机上的漏洞利用实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/28/Bluetooth-Vul-3/">蓝牙App漏洞系列分析之三</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/name-spoof/">“同形异义字”钓鱼攻击，钉钉中招</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/12/Bluetooth-Vul-2/">蓝牙App漏洞系列分析之二</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/bypass360-analysis/">分享一种可关闭大多数杀软的技术（对360安全卫士已验证成功）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/14/wannacry/">首发 | Wannacry勒索软件母体主程序逆向分析（含临时解决方案自动化工具</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.zerokeeper.com/" title="小李飞刀" target="_blank">小李飞刀</a><ul></ul><a href="http://cybersec.blog.51cto.com" title="网络空间安全的道与术" target="_blank">网络空间安全的道与术</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>