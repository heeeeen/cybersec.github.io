<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>CVE-2016-10277在MOTO X手机上的漏洞利用实践 | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CVE-2016-10277在MOTO X手机上的漏洞利用实践</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CVE-2016-10277在MOTO X手机上的漏洞利用实践</h1><div class="post-meta">Jul 14, 2017<span> | </span><span class="category"><a href="/categories/移动安全/">移动安全</a></span></div><div class="post-content"><p>作者：thor</p>
<p>CVE-2016-10277是存在于摩托罗拉系列手机的bootloader高危漏洞，可以通过内核命令注入劫持手机的启动流程，加载攻击者控制的initramfs，从而达到root提权的目的。我们手上正好有一个摩托罗拉的MOTO X手机，于是参照[1]的漏洞利用过程，将CVE-2016-10277的漏洞利用过程实践了一把，复现过程还是十分曲折。</p>
<h3 id="0x00-系统环境"><a href="#0x00-系统环境" class="headerlink" title="0x00 系统环境"></a>0x00 系统环境</h3><p>1. 手机： MOTO X(XT1581)<br>2. 系统固件版本：XT1581_KINZIE_RETCN_DS_5.1.1_LPK23.229，未root<br>3. Android版本：5.1.1</p>
<p>在漏洞利用过程中需要用到手机boot.img中的aboot、initramfs，手机没有root的话是无法提取系统固件的，幸好我们在网上找到了对应的系统固件，可以直接提取使用。<a id="more"></a></p>
<h3 id="0x01-漏洞原理"><a href="#0x01-漏洞原理" class="headerlink" title="0x01 漏洞原理"></a>0x01 漏洞原理</h3><p>CVE-2016-10277的基本原理并不复杂，主要就是可以通过fastboot向bootloader注入内核命令参数。首先我们可以通过fastoot oem config 查看配置参数：<br><img src="/2017/07/14/Moto-bootloader-exploit/1.png" alt="1"></p>
<p>这些参数都未受保护，即使bootloader已锁，仍然可以通过fastboot oem config命令配置：</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/2.png" alt="2"></p>
<p>漏洞就在于bootloader未对配置的这些参数进行过滤，而这些参数会直接传递给内核的命令行。内核命令行参数的注入会影响bootloader的加载过程，攻击者如果精心构造某些参数，将达到控制手机启动，甚至root提权的目的。</p>
<h3 id="0x02-漏洞验证"><a href="#0x02-漏洞验证" class="headerlink" title="0x02 漏洞验证"></a>0x02 漏洞验证</h3><p>首先我们要先确定MOTO X是否受CVE-2016-10277漏洞的影响。</p>
<h4 id="1-注入参数设置property"><a href="#1-注入参数设置property" class="headerlink" title="1) 注入参数设置property"></a>1) 注入参数设置property</h4><p>执行命令：</p>
<p>fastboot oem config fsg-id “a androidboot.bar=1”</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/3.png" alt="3"></p>
<p>该命令注入了androidboot.bar=1参数，该参数如果注入成功，将会设置系统的ro.boot.bar属性为1。当然,这里我们只是虚构了一个bar属性。</p>
<h4 id="2-启动系统查看property"><a href="#2-启动系统查看property" class="headerlink" title="2) 启动系统查看property"></a>2) 启动系统查看property</h4><p>执行命令：</p>
<p>fastoot continue<br>adb shell getprop ro.boot.bar</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/4.png" alt="4"></p>
<p>可以看到成功设置系统属性，说明内核命令行参数注入成功，确定MOTO X受CVE-2016-10277漏洞的影响。</p>
<h3 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h3><p>通过该漏洞的命令行注入，我们可以向内核命令行注入众多参数，而这些参数又会在OS启动阶段多个地方被引用，因此该漏洞的攻击面是很广的，这里我们主要尝试能否通过该漏洞进行root提权。我们首先简单介绍下手机的启动过程，找到其中的利用点。</p>
<h4 id="1-Android手机的Secure-Boot过程"><a href="#1-Android手机的Secure-Boot过程" class="headerlink" title="1) Android手机的Secure Boot过程"></a>1) Android手机的Secure Boot过程</h4><p>MOTO系列的手机大部分使用高通芯片，而高通芯片的手机大致启动过程如下：</p>
<p>[Primary Bootloader (PBL)]<br><code>-.
[Secondary Bootloader (SBL)]</code>-.<br>[Applications Bootloader (ABOOT)]<br><code>-.
[{boot,recovery}.img]
|-- Linux Kernel</code>– initramfs<br>`-.<br>[system.img]</p>
<p>手机开机后，首先启动的是bootloader，而bootloader又大致分为3个阶段，最先启动的是PBL，然后是SBL、ABOOT，最后通过ABOOT从boot.img或recovery.img中加载linux kernel和initramfs，进入系统加载阶段。initramfs是一个内存文件系统，bootloader一般会从固定的内存地址中加载，系统启动后会挂载到rootfs，即根目录/。initramfs包含很多重要文件，包括系统启动后第一个用户态进程init、服务启动脚本init.rc、selinux策略文件sepolicy、adbd程序等。如果我们能够让系统启动时加载我们构造的initramfs，那么我们就可以在这里面做很多劫持动作。而CVE-2016-10277的一个攻击面就是通过注入内核命令参数控制手机启动时的initramfs加载地址，加载我们指定的initramfs。</p>
<h4 id="2-通过参数注入劫持initramfs加载"><a href="#2-通过参数注入劫持initramfs加载" class="headerlink" title="2) 通过参数注入劫持initramfs加载"></a>2) 通过参数注入劫持initramfs加载</h4><p>通过CVE-2016-10277漏洞我们可以向内核注入initrd参数，该参数控制了initramfs的内存加载地址，参数形式如下：</p>
<p>initrd=&lt;initramfs_address&gt;,&lt;initramfs_size&gt;</p>
<p>首先我们测试是否可以劫持initramfs的加载地址，命令如下：</p>
<p>fastboot oem config fsg-id “a initrd=0x12341234,1024”<br>fastboot continue</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/5.png" alt="5"></p>
<p>执行命令后我们发现手机进入无限循环启动，无法进入系统，手机已崩溃，说明initrd参数起到了作用。为了验证能否顺利劫持initramfs加载，我们还需要找到可用的initramfs，并且找到向内存注入可控initramfs的方法。</p>
<p>由于不同的手机系统固件不一样，initramfs也不通用，我们只有通过网上下载的对应系统固件来提取initramfs。下载固件后解压缩找到boot.img，使用imgtool工具提取内核文件：</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/6.png" alt="6"></p>
<p>这里的ramdisk即是我们要找得initramfs。接下来我们想办法向内存中注入我们的ramdisk，可通过如下命令：</p>
<p>fastboot flash thor ramdisk</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/7.png" alt="7"></p>
<p>我们向bootloader flash一个不存在image，虽然不能刷入，但是ramdisk肯定已经存在于手机内存中某个位置，接下来我们需要的就是找到这个位置。ABOOT二进制文件中有一个target_get_scratch_address函数，该函数返回的地址就是downloaded image存在的地址，所以我们通过IDA查看ABOOT文件就能够找到该地址。</p>
<p>ABOOT文件存在于bootloader中，提取固件中的bootloader.img，使用imgtool提取却出错了：</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/8.png" alt="8"></p>
<p>用010editor查看，看到了aboot的存在，但是bootloader.img应该是做了定制，不是普通的image文件。</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/9.png" alt="9"></p>
<p>使用谷歌大法，找到了一个专门用于提取moto image文件的python脚本<a href="Moto-bootloader-exploit/">https://github.com/laginimaineb/unpack_motoboot</a>：</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/10.png" alt="10"></p>
<p>成功提取aboot文件后，放入IDA查看，由于没有删掉符号信息，可以快速定位到target_get_scratch_address函数:</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/11.jpg" alt="11"></p>
<p>我们从而得到flash image时image在内存中的地址为：0x11000000。<br>综上，我们终于可以尝试劫持initramfs的加载：</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/12.png" alt="12"></p>
<p>不幸的是，手机依然无限循环重启。问题出在什么地方的？由于我们看不到任何启动时打印的信息，也不知从何入手。漏洞的发现者做出了一个猜测，有可能是flash image后，手机的启动过程中污染了我们发送的initramfs，导致initramfs被破坏。因此，我们需要将控制的initramfs填充，将真正的initramfs放到高地址的内存中：</p>
<p>.——————————–.———————-.<br>| Physical Address | Data |<br>|——————————–|———————-|<br>| SCRATCH_ADDR | Corrupted PADDING |<br>| SCRATCH_ADDR + sizeof(PADDING) | Controlled initramfs |<br>`——————————–’———————-‘</p>
<p>我们选择padding的数据长度为32MB，</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/13.png" alt="13">]</p>
<p>这次终于成功启动了系统，说明我们成功劫持了initramfs:</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/13_1.png" alt="13_1"></p>
<h4 id="3-构造initramfs获取root权限"><a href="#3-构造initramfs获取root权限" class="headerlink" title="3) 构造initramfs获取root权限"></a>3) 构造initramfs获取root权限</h4><p>成功劫持了initramfs后，我们需要想办法替换或修改initramfs中的文件来进行root提权。我们首先解压缩initramfs,它是一个cpio打包、gzip压缩的文件：</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/14.png" alt="14"></p>
<p>我们在sbin目录下看到了adbd二进制文件，它是我们我们执行adb shell时的服务程序。</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/15.png" alt="15"></p>
<p>我们想要root提权，一种方法就是patch adbd程序，让adb shell直接以root权限执行，而不是降权执行。在AOSP的adbd源码中我们看到，只要我们patch掉should_drop_privileges的执行，那么就能让adb shell以root权限执行。</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/16.png" alt="16"></p>
<p>但是，我们将adbd放入IDA一看，发现strip掉了函数符号，IDA在ARM64下没法F5，而且厂商在AOSP基础上做了很多定制，导致使用strings找特征都不好使。</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/17.jpg" alt="17"></p>
<p>如果要直接patch adbd程序估计得花很多时间逆向分析，这里我们走一下捷径，直接分析<a href="Moto-bootloader-exploit/">https://github.com/alephsecurity/initroot</a>patch后的adbd，然后对比原来的adbd程序，分析patch点，最后根据32位程序来推测64位arm程序可能的patch点。事实证明这是一条快速通道，我们很快就对比找到了patch点：</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/23.png" alt="23"></p>
<p>一共两处patch点，根据patch点的结构，我们在64位adbd中找到相似的patch点：</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/25.png" alt="25"></p>
<p>于是我们patch掉这两个地方，用patch后的adbd替换原来initramfs中的程序，重新打包运行，adb shell直接就是root权限：</p>
<p><img src="/2017/07/14/Moto-bootloader-exploit/26.png" alt="26"></p>
<p>通过类似的方法，我们还可以patch init程序，关掉selinux。</p>
<h3 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h3><p>CVE-2016-10277是一个比较有意思的漏洞，原理不复杂，只是一个简单的命令行参数注入，但是它的攻击面却很广，危害也很大。我们在复现该漏洞的利用过程中，经历了非常曲折的一个过程。本来漏洞发现者已经给出了MOTO G4、G5手机可用的exploit，但是我们的手机是MOTO X，原来的exp都没法用，只有自己摸索漏洞利用过程。在研究过程学习了secure boot、aboot、selinux等知识，该漏洞的利用覆盖了很广的知识面，值得研究。</p>
<h3 id="参考文献："><a href="#参考文献：" class="headerlink" title="参考文献："></a>参考文献：</h3><p>[1] <a href="https://alephsecurity.com/2017/06/07/initroot-moto/" target="_blank" rel="external">https://alephsecurity.com/2017/06/07/initroot-moto/</a></p>
</div><div class="tags"><a href="/tags/android/">android</a></div><div class="post-nav"><a href="/2017/08/04/github-infoleak/" class="pre">Github信息泄露升级版案例</a><a href="/2017/06/28/Bluetooth-Vul-3/" class="next">蓝牙App漏洞系列分析之三</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Malware分析/">Malware分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/渗透测试/">渗透测试</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web安全/">Web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/">二进制</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/原创漏洞/">原创漏洞</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/原创漏洞/">原创漏洞</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安卓/">安卓</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/移动安全/">移动安全</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/移动安全/二进制安全/">二进制安全</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/antiav/" style="font-size: 15px;">antiav</a> <a href="/tags/cknife/" style="font-size: 15px;">cknife</a> <a href="/tags/ios/" style="font-size: 15px;">ios</a> <a href="/tags/ms509/" style="font-size: 15px;">ms509</a> <a href="/tags/wannacry/" style="font-size: 15px;">wannacry</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/23/Rootme-uaf-writeup/">Rootme CTF UAF Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/22/android-blueborne2/">Android蓝牙远程命令执行漏洞利用实践 exploit优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/14/blueborne/">Android蓝牙远程命令执行漏洞利用实践:从PoC到exploit</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/04/github-infoleak/">Github信息泄露升级版案例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/14/Moto-bootloader-exploit/">CVE-2016-10277在MOTO X手机上的漏洞利用实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/28/Bluetooth-Vul-3/">蓝牙App漏洞系列分析之三</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/name-spoof/">“同形异义字”钓鱼攻击，钉钉中招</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/12/Bluetooth-Vul-2/">蓝牙App漏洞系列分析之二</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/bypass360-analysis/">分享一种可关闭大多数杀软的技术（对360安全卫士已验证成功）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/14/wannacry/">首发 | Wannacry勒索软件母体主程序逆向分析（含临时解决方案自动化工具</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.zerokeeper.com/" title="小李飞刀" target="_blank">小李飞刀</a><ul></ul><a href="http://cybersec.blog.51cto.com" title="网络空间安全的道与术" target="_blank">网络空间安全的道与术</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>