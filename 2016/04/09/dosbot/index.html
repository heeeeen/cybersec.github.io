<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>一个DOS攻击木马的详细分析过程 | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一个DOS攻击木马的详细分析过程</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">一个DOS攻击木马的详细分析过程</h1><div class="post-meta">Apr 9, 2016<span> | </span><span class="category"><a href="/categories/二进制/">二进制</a></span></div><div class="post-content"><p>作者：expsky</p>
<h3 id="0x01-起因"><a href="#0x01-起因" class="headerlink" title="0x01 起因"></a>0x01 起因</h3><p>网路流量里发现了大量的的1.exe的文件，而且一直在持续，第一感觉就像是一个木马程序，而且每个1.exe的MD5都不一样，对比发现只有几个字节不一样（如下图），按了几下PgDn就到尾了！一看大小，只有5k。一下想到了以前分析的一个老外写的兼容xp,win7,x86,x64系统的非常小的MBR bootkit木马，当时分析的时候真的是忍不住拍手叫绝。喜欢“小而美”的东西，后面分析里有段代码，也可以看出作者写代码的确比较讲究：检查http方法是POST还是GET时，只比较一个首字母。<br><a id="more"></a><br>一时兴起，决定深入分析一下这个样本，于是有了这篇文章。<br><img src="http://image.3001.net/images/20160401/14594789651360.png" alt=""></p>
<h3 id="0x02-网络流量里为什么有大量1-exe文件"><a href="#0x02-网络流量里为什么有大量1-exe文件" class="headerlink" title="0x02 网络流量里为什么有大量1.exe文件 ?"></a>0x02 网络流量里为什么有大量1.exe文件 ?</h3><p>木马加壳加密，反调试，在这个年代已经是基本配置了，此文不是讲脱壳，所以这里省略一万字直接穿越到脱完壳后，样本的确非常小，一共就只有20多个函数。本文叫详细分析，所以把这个样本的所有边边角角都逆向出来了，看着有了名字的函数，一下舒服多了。（<em>​编者注：本文已于4月9日发布于Freebuf，作者expsky为了纪念在FreeBuf上的第一篇文章，特意有了一个函数叫FreeBuf，如果非要问为什么叫这个名字，那我们就点进去看看，因为它真的就只是free buffer</em>）</p>
<p><img src="http://image.3001.net/images/20160401/14594790228954.png" alt=""></p>
<p>网络流量里有大量1.exe，而且每个MD5值不一样，先猜测木马是不是一个下载者，运行后就不停的下载其他木马</p>
<p>经过分析，定位到了如下关键函数，找出了原因，和猜想的还不一样。</p>
<p>1）读取自身文件内容</p>
<p><img src="http://image.3001.net/images/20160401/14594790971163.png" alt=""></p>
<p>2）修改自身PE文件的时间戳，每次递增1</p>
<p>（这就是为什么每个1.exe的MD5值都不一样）</p>
<p><img src="http://image.3001.net/images/20160401/14594791603139.png" alt=""></p>
<p>3）post数据，并上传文件</p>
<p><img src="http://image.3001.net/images/20160401/14594792085250.png" alt=""></p>
<p><img src="http://image.3001.net/images/20160401/14594792479762.png" alt=""></p>
<p>如下是第2个appendstr附加的数据，从内容以及0x0D, 0x0A的换行，很容易认出是在构建http的协议头。最后一行的64字节的字符串，是提交的apikey，而这个apikey到底是什么呢？继续往下分析。</p>
<p><img src="http://image.3001.net/images/20160401/14594792982437.png" alt=""></p>
<p>如下是第4个appendstr附加的数据，也是在构建http协议头，Content-Disposition字段指明了上传文件的文件名叫1.exe</p>
<p><img src="http://image.3001.net/images/20160401/14594793354713.png" alt=""></p>
<p>4）木马为什么要循环上传自己，而又把自己上传到哪里去了呢？</p>
<p><img src="http://image.3001.net/images/20160401/14594793902660.png" alt=""></p>
<p>先将前面构造的需要POST的IStream流数据转到buffer里，然后提交给了 www.virustotal.com/vtapi/v2/file/scan</p>
<p>VirusTotal是一个全球知名的提供可疑文件分析服务的网站，/vtapi/v2/file/scan 这个是开放给他的会员扫可疑文件的API接口，现在可以来回答前面看到的那个64字节的apikey是什么：会员必须向VirusTotal申请到这个apikey后，才能正常使用这个扫文件的API接口</p>
<p><img src="http://image.3001.net/images/20160401/14594794741503.png" alt=""></p>
<p>上面是httpRequest的部分内容，这个函数就是用WinHTTP系列SDK完成http请求的函数，不需要细看，</p>
<p>这里只是提一下框住的那句汇编cmp ecx, 50h，晃眼一看还以为是在比较是不是80端口，原来是在检查函数参数http方法是GET还是POST, ascii 80也是字母”P”，只比较了一个首字母，这就是文章最开始提到的作者写代码比较讲究，还有不少作者编码很讲究的地方，与本文主题关系不大，这里就不细讲了。</p>
<p>我们再回到上面核心函数末尾</p>
<p><img src="http://image.3001.net/images/20160401/14594795297945.png" alt=""></p>
<p>木马请求完返回的结果没有使用就直接被正义使者FreeBuf给干掉了，这是什么意思？</p>
<p>FreeBuf后面那句 jmp loc_401451 原来是一个死循环，又跳到上面修改自身时间戳的地方</p>
<p>到这里我们就清楚了原来木马一直在循环上传自身，每个循环会递增PE的TimeDataStamp字段（[PE_Base+0x3c] + 0×8），所以每次提交的1.exe的MD5都不一样，因为VirusTotal对已经有MD5值分析过了的文件，就不会再分析了，直接返回以前分析的结果。所以VirusTotal返回的结果木马也不关心，直接free掉。这个木马是想攻击VirusTotal……？</p>
<p>分析到这里，就像给这个函数取的名字一样“LoopSubmitVirusTotal”，已经很清楚了整个过程，而且已经完全解答了分析这个样本的起因：</p>
<p>为什么网络流量里有大量的1.exe文件，为什么每个文件的MD5值不一样，而且只有微小的差别。</p>
<p>到这里文章仿佛也该结束了：《一个木马作者报复安全厂商的故事》</p>
<h3 id="0x03-揭开木马的真实意图"><a href="#0x03-揭开木马的真实意图" class="headerlink" title="0x03 揭开木马的真实意图"></a>0x03 揭开木马的真实意图</h3><p>这个故事始终觉得怪怪的，木马作者有什么好处呢？那就继续把剩下几个没逆完的函数，全部看完吧</p>
<p><img src="http://image.3001.net/images/20160401/14594795844820.png" alt=""></p>
<p>如上图，又发现一个和前面httpRequest函数几乎一模一样的函数，唯一的区别是，这个函数自己把写了一长串WinHTTP SDK，辛苦获取到的Response返回结果，直接在函数内部就给Free掉了。换句话说就是，这是一个Http请求的函数，完成了所有工作后，却什么也不返回。外部看来和一个空函数有什么区别？</p>
<p>如下图，我们来到了调用这个函数的地方，看完这里基本就清楚了是怎么回事了</p>
<p><img src="http://image.3001.net/images/20160401/1459479627723.png" alt=""></p>
<p>上层函数又是一个死循环，接收参数：服务器主机地址和路径后，就一直循环发起GET请求。原来这是在发起应用层的DOS攻击，所以前面的函数也不需要关心请求的返回结果直接就free了。</p>
<p><img src="http://image.3001.net/images/20160401/14594796792163.png" alt=""></p>
<p>如上图，再往外层分析，进一步确认这是一个应用层DOS攻击木马。 对目标服务器循环GET的那个函数又被启了100个线程，的确是想把对方搞死的节奏</p>
<p>真相越来越明朗，还剩下最后一个问题，攻击的目标服务器，从哪里获取？</p>
<p>经验猜测是通过C&amp;C获取，继续来证实，果然找到了如下C&amp;C通讯函数，是通过twitter的博客页面，实现的http隐蔽通讯，接收命令</p>
<p><img src="http://image.3001.net/images/20160401/14594797213882.png" alt=""></p>
<p>如下，打开twitter.com/pidoras6页面来证实一下（只关心祖国大事的好同志，还花了20元去买了一个VPN）</p>
<p><img src="http://image.3001.net/images/20160401/14594797595132.jpg" alt=""></p>
<p>打开页面，置顶的推文一下就发现了5个反括号，控制命令是被加了密的，其实都不用去逆向解密函数，看长相就挺眼熟，最后末尾有等号，很像base64（base64编码的字符串的长度是以3来对齐，不足的用=来补齐，所以在最后经常能看到一个或两个等号）</p>
<p><img src="http://image.3001.net/images/20160401/14594798114557.jpg" alt=""></p>
<p>并没有对控制命令做加密，只是简单用了base64编码，让别人不要一眼看出是什么就行了。</p>
<p>后面的代码已经不重要，也能猜到，网页的utf8编码转为本地编码，调用WinHttpCrackUrl函数拆解收到的攻击目标URL，然后回写到全局变量里，供那100个攻击线程循环去GET目标</p>
<p><img src="http://image.3001.net/images/20160401/14594798488835.png" alt=""></p>
<h3 id="0x04-尾声"><a href="#0x04-尾声" class="headerlink" title="0x04 尾声"></a>0x04 尾声</h3><p>回头再来看起因的那些大量提交给VirusTotal的1.exe，仿佛和木马接收命令进行DOS攻击没什么关系，</p>
<p>推测作者的目的可能是：因为VirusTotal是限制会员提交样本的频率的，木马首先去攻击VirusTotal后，VirusTotal可能会把本机的IP拉到黑名单里，而现在一些网络检测设备都可能去调用VirusTotal的接口检查样本（VirusTotal还有个提交样本MD5查询的接口，沙箱等很多安全设备经常会使用）如果本地有类似的安全设备，这样就可以把安全设备的VirusTotal扫描功能给搞废掉。</p>
<p>我尝试去打开攻击目标页面w0rm.in，却为什么总是响应超时？w0rm.in这个关键字仿佛直指一名俄罗斯黑客？攻击VirusTotal的行为真的和猜想一样吗？这一切会不会只是一次例行的压力测试？w0rm如果真的是一名黑客，那w0rm的初恋和木马作者的老婆究竟是不是同一个人？这背后是道德的沦丧还是人性的扭曲……敬请关注今晚25点30分的《走近科学》，让我们一起跟随镜头，揭开you call, i jmp那些鲜为人知的故事。</p>
</div><div class="tags"></div><div class="post-nav"><a href="/2016/04/11/idman-analysis/" class="pre">IDMan.exe漏洞分析及利用</a><a href="/2016/03/31/cknife-advanced/" class="next">打狗棒法之进阶篇：Cknife修改配置法秒过安全狗</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IOS/">IOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Malware分析/">Malware分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/渗透测试/">渗透测试</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web安全/">Web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/">二进制</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/原创漏洞/">原创漏洞</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/原创漏洞/">原创漏洞</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安卓/">安卓</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/移动安全/">移动安全</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/移动安全/二进制安全/">二进制安全</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/antiav/" style="font-size: 15px;">antiav</a> <a href="/tags/cknife/" style="font-size: 15px;">cknife</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/ms509/" style="font-size: 15px;">ms509</a> <a href="/tags/wannacry/" style="font-size: 15px;">wannacry</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/14/blueborne/">Android蓝牙远程命令执行漏洞利用实践:从PoC到exploit</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/04/github-infoleak/">Github信息泄露升级版案例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/14/Moto-bootloader-exploit/">CVE-2016-10277在MOTO X手机上的漏洞利用实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/28/Bluetooth-Vul-3/">蓝牙App漏洞系列分析之三</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/name-spoof/">“同形异义字”钓鱼攻击，钉钉中招</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/12/Bluetooth-Vul-2/">蓝牙App漏洞系列分析之二</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/bypass360-analysis/">分享一种可关闭大多数杀软的技术（对360安全卫士已验证成功）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/14/wannacry/">首发 | Wannacry勒索软件母体主程序逆向分析（含临时解决方案自动化工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/04/Bluetoooth_Vul_1/">蓝牙App漏洞系列分析之一</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/21/android-telephony-dos/">Android Telephony拒绝服务漏洞（CVE-2016-6763）分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.zerokeeper.com/" title="小李飞刀" target="_blank">小李飞刀</a><ul></ul><a href="http://cybersec.blog.51cto.com" title="网络空间安全的道与术" target="_blank">网络空间安全的道与术</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>