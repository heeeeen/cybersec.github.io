<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>SQLCipher之攻与防 | MS509 Team</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SQLCipher之攻与防</h1><a id="logo" href="/.">MS509 Team</a><p class="description">Mission Studio</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">SQLCipher之攻与防</h1><div class="post-meta">Jul 12, 2016<span> | </span><span class="category"><a href="/categories/移动安全/">移动安全</a></span></div><div class="post-content"><h2 id="0x00-SQLCipher"><a href="#0x00-SQLCipher" class="headerlink" title="0x00 SQLCipher"></a>0x00 SQLCipher</h2><p>在移动端，不管是iOS还是Android，开发人员用的最多的本地数据库非SQlite莫属了。SQLite是一个轻量的、跨平台的、开源的数据库引擎，它的在读写效率、消耗总量、延迟时间和整体简单性上具有的优越性，使其成为移动平台数据库的最佳解决方案。</p>
<p>但是，用SQLite保存一些不是很敏感的信息还可以接受，存储敏感信息就值得商榷了，免费版的SQLite中的信息是明文存放的，你甚至直接用文本编辑器打开都可以看到敏感内容，比如下面这个:</p>
<p><img src="/2016/07/12/sqlcipher-defense-attack/1.png" alt="enter description here"></p>
<p>其实SQLite是提供了加密功能的，即SQLite Encryption Extension (SEE)，但是，要收费！还不便宜，2000刀。Coder们穷啊，于是大家寻找免费的解决方案，最终SQLCipher成了比较理想的选择，因为它免费、开源，而其它家的SQLiteEncrypt、SQLiteCrypt等还是要收费。</p>
<p>SQLCipher也有收费版本，但收费版本只是在集成、依赖等易用性方面有优势，功能和免费差不多，因此免费版的SQLCipher成了Coder们的选择对象。</p>
<p>SQLCipher采用的是数据库文件整体加密的策略，使用256-bit AES加密，从算法角度来看是相当强悍了。于是，加密后的文件看起来及时这样了：</p>
<p><img src="/2016/07/12/sqlcipher-defense-attack/2.png" alt="enter description here"></p>
<p>完全是天书嘛，ok，可以洗洗睡了。但真的就安全了吗？呵呵。</p>
<h3 id="0x01-谋攻篇"><a href="#0x01-谋攻篇" class="headerlink" title="0x01 谋攻篇"></a>0x01 谋攻篇</h3><p>密码学中有一句比较经典的话：一切秘密寓于密钥之中。只要我们拿到了密钥，剩下的问题都不是问题了。下面我们就来分析一下SQLCipher的密钥和加密过程。<br>根据官方的描述，SQLCipher是整体加密方案：</p>
<blockquote>
<p>Transparent – An application doesn’t require any special knowledge of the underlying database security. Applications use the standard SQLite API to manipulate tables using SQL. Behind the scenes the library silently manages the security.</p>
<p>On-the-fly – SQLCipher encrypts and decrypts in chunks called pages, as needed, so it doesn’t operate on the database all at one time. This means SQLCipher<br>starts up and closes down quickly<br>performs very well even with very large databases<br>works with SQLite indexing (i.e. retrieving a single record using an indexed search can incur as little as 5% overhead above a standard SQLite database)</p>
</blockquote>
<p>它并不是对表或者列进行加密，也就是说他的数据库密钥只有一个，拿下这一个密钥就成。</p>
<p>SQLCipher在iOS上是这样用的：</p>
<p>1）在项目中加入sqlite3.h和sqlite3.m；</p>
<p>2）使用下面代码连接数据库：</p>
<p><img src="/2016/07/12/sqlcipher-defense-attack/3.png" alt="enter description here"></p>
<p>其中的key就是我们需要的密钥！然后通过sqlite3_key函数将该key与数据库关联起来，接下来就可以执行sql语句操作了。程序员肯定觉得好用啊，就增加了两行语句就完成了加密功能，直接拷贝官方的代码到自己的工程中，把“StrongPassword”换成自己的密钥就成。真实容易啊，那么我攻击也很easy啦。</p>
<p>一般来说，对付这种程度的加密，只需要使用静态分析即可。对于iOS程序，将程序拖到ida中，找到sqlite3_key函数相关引用地址，顺藤摸瓜，基本就搞定了。下面就是某应用中定位该函数在setKey方法中，该方法是在它的数据open方法中调用的，可以看到已经明文硬编码了数据库的密码（图中抹红部分）。</p>
<p><img src="/2016/07/12/sqlcipher-defense-attack/4.png" alt="enter description here"></p>
<p>拿到密码后有个偷懒的方法可以直接打开加密数据库：使用SQLiteManager，它支持SQLCipher加密的数据库，会提示输入数据库密码，不需要自己写程序了，而且浏览数据也很方便。</p>
<p><img src="/2016/07/12/sqlcipher-defense-attack/5.png" alt="enter description here"></p>
<p>对于Android版的程序，如果没加壳的话，也是很好分析的。Android调用SQLCipher使用下面的方式：</p>
<p><img src="/2016/07/12/sqlcipher-defense-attack/6.png" alt="enter description here"><br>openOrCreateDatabase方法的第二个参数就是密钥了。在jeb反编译出来的代码中寻找相关的方法就可以摸到相应的数据库密钥。</p>
<p>到这儿程序员可能要想了，我不硬编码看你咋整，我在代码中经过加减乘除、异或后在算出key，或者更狠一点用用户口令等进行动态解密变换，密钥就不会在程序中出现了。</p>
<p>但攻击者还有n多招数还没上场了，比如动态调试，在输入key的方法入口打断点，对key的明文进行拦截。<br>还有就是hook技术，对于Android上的应用，我们可以使用CydiaSubstrate，使用MS.hookClassLoad 方法将openOrCreateDatabase进行hook处理:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">public class Main &#123;</div><div class="line"></div><div class="line">    static void hookCryptoKey() &#123;</div><div class="line">        MS.hookClassLoad(&quot;net.sqlcipher.database.SQLiteDatabase&quot;,</div><div class="line">            new MS.ClassLoadHook() &#123;</div><div class="line">                public void classLoaded(Class&lt;?&gt; arg0) &#123;</div><div class="line">                    Log.d(&quot;MyHook&quot;, &quot;##### Class Loaded\n&quot;);</div><div class="line"></div><div class="line">                    Method openOrCreateDatabase;</div><div class="line">                    try &#123;</div><div class="line">                        openOrCreateDatabase = arg0.getMethod(</div><div class="line">                            &quot;openOrCreateDatabase&quot;,</div><div class="line">                            new Class[] &#123; File.class, String.class, SQLiteDatabase.CursorFactory.class &#125;);</div><div class="line"></div><div class="line">                    &#125; catch (NoSuchMethodException e) &#123;</div><div class="line">                        openOrCreateDatabase = null;</div><div class="line">                        Log.d(&quot;MyHook&quot;,</div><div class="line">                            &quot;##### Unable to find method\n&quot;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    if (openOrCreateDatabase != null) &#123;</div><div class="line">                        Log.d(&quot;MyHook&quot;, &quot;##### Found method\n&quot;);</div><div class="line">                        try &#123;</div><div class="line">                            final MS.MethodPointer old = new MS.MethodPointer();</div><div class="line">                            MS.hookMethod(arg0,</div><div class="line">                                openOrCreateDatabase,</div><div class="line">                                new MS.MethodHook() &#123;</div><div class="line">                                    public Object invoked(Object arg0,</div><div class="line">                                        Object... args)</div><div class="line">                                    throws Throwable &#123;</div><div class="line">                                        Log.d(&quot;MyHook&quot;, &quot;##### Error: &quot; + Thread.currentThread().getStackTrace());</div><div class="line">                                        Log.d(&quot;MyHook&quot;,</div><div class="line">                                            &quot;###### Method hooked, stealing key: &quot; + args[1]);</div><div class="line"></div><div class="line">                                        return old.invoke(arg0, args);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;, old);</div><div class="line">                        &#125; catch (Exception e) &#123;</div><div class="line">                            System.out</div><div class="line">                            .println(&quot;#### Unable to find class\n&quot;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">static void initialize() &#123; </div><div class="line">    hookCryptoKey();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码可以将openOrCreateDatabase方法钩住并将第二个参数key在日志中打印出来，无视你前期经过了多少隐藏、变换。至于Substrate的用法这里就不细讲了，各位看官可以参考网上的资料。当然，你也可以尝试其它hook框架，如Xposed。</p>
<p>程序员可能不服气，我还可以上加壳，在iOS端我也可以上混淆、lua动态网上加载等手段啊？不过这貌似超出了SQLCipher攻防的地盘了，是程序本地保护的大范畴，有机会再研究。</p>
<h3 id="0x02-防？"><a href="#0x02-防？" class="headerlink" title="0x02 防？"></a>0x02 防？</h3><p>写到这儿，其实对本地数据库加密是感到沮丧的，这完全就是把门锁和钥匙放在一起的做法嘛，不管你在本地上任何软的手段（硬件另说，如果你的密钥、算法都放在硬件中，比如USBKey中，安全性应该是有本质上的提升），不管是简单变换还是混淆、加壳、反调试、反hook，都难保不被攻击者破解掉，不过是或多或少延缓找到钥匙的时间罢了。</p>
<p>因此，建议除了以下情况，不要使用SQLCipher之类的本地数据库加密：</p>
<ol>
<li>非敏感数据，爱咋用咋用</li>
<li>用户自己的数据，可以采用用户口令、指纹等方式直接或间接保护，因为这种情况下key其实是随用户走的，可以做到key和算法、数据的分离</li>
</ol>
<p>其它情况推荐数据放在APP的服务端，将客户端做瘦，将安全的防护重点放在通信和服务端的防护上。</p>
</div><div class="tags"><a href="/tags/ios/">ios</a></div><div class="post-nav"><a href="/2016/07/12/redbomb/" class="pre">躲不掉的红色炸弹，这次真的「爆」了</a><a href="/2016/07/05/arm-rop/" class="next">ARM栈溢出攻击实践：从虚拟环境搭建到ROP利用</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IOS/">IOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Malware分析/">Malware分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/">WEB</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WEB/渗透测试/">渗透测试</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web安全/">Web安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/">二进制</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/二进制/原创漏洞/">原创漏洞</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/原创漏洞/">原创漏洞</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全工具/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安卓/">安卓</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/移动安全/">移动安全</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/移动安全/二进制安全/">二进制安全</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/antiav/" style="font-size: 15px;">antiav</a> <a href="/tags/cknife/" style="font-size: 15px;">cknife</a> <a href="/tags/ms509/" style="font-size: 15px;">ms509</a> <a href="/tags/ios/" style="font-size: 15px;">ios</a> <a href="/tags/wannacry/" style="font-size: 15px;">wannacry</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/22/android-blueborne2/">Android蓝牙远程命令执行漏洞利用实践 exploit优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/14/blueborne/">Android蓝牙远程命令执行漏洞利用实践:从PoC到exploit</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/04/github-infoleak/">Github信息泄露升级版案例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/14/Moto-bootloader-exploit/">CVE-2016-10277在MOTO X手机上的漏洞利用实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/28/Bluetooth-Vul-3/">蓝牙App漏洞系列分析之三</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/14/name-spoof/">“同形异义字”钓鱼攻击，钉钉中招</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/12/Bluetooth-Vul-2/">蓝牙App漏洞系列分析之二</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/06/bypass360-analysis/">分享一种可关闭大多数杀软的技术（对360安全卫士已验证成功）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/14/wannacry/">首发 | Wannacry勒索软件母体主程序逆向分析（含临时解决方案自动化工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/04/Bluetoooth_Vul_1/">蓝牙App漏洞系列分析之一</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.zerokeeper.com/" title="小李飞刀" target="_blank">小李飞刀</a><ul></ul><a href="http://cybersec.blog.51cto.com" title="网络空间安全的道与术" target="_blank">网络空间安全的道与术</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">MS509 Team.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>